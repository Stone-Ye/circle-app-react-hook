{"ast":null,"code":"import _regeneratorRuntime from \"/Users/stoneye/react_project/circle-app-react-hook/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _slicedToArray from \"/Users/stoneye/react_project/circle-app-react-hook/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport { __awaiter } from \"tslib\";\nimport { mergeProps } from '../../utils/with-default-props';\nimport React, { useEffect, useRef, useState } from 'react';\nimport { useLockFn, useThrottleFn } from 'ahooks';\nimport { withNativeProps } from '../../utils/native-props';\nimport { getScrollParent } from '../../utils/get-scroll-parent';\nimport { useConfig } from '../config-provider';\nimport DotLoading from '../dot-loading';\n\nfunction isWindow(element) {\n  return element === window;\n}\n\nvar classPrefix = \"adm-infinite-scroll\";\nvar defaultProps = {\n  threshold: 250,\n  children: function children(hasMore, failed, retry) {\n    return React.createElement(InfiniteScrollContent, {\n      hasMore: hasMore,\n      failed: failed,\n      retry: retry\n    });\n  }\n};\nexport var InfiniteScroll = function InfiniteScroll(p) {\n  var props = mergeProps(defaultProps, p);\n\n  var _useState = useState(false),\n      _useState2 = _slicedToArray(_useState, 2),\n      failed = _useState2[0],\n      setFailed = _useState2[1];\n\n  var doLoadMore = useLockFn(function (isRetry) {\n    return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.prev = 0;\n              _context.next = 3;\n              return props.loadMore(isRetry);\n\n            case 3:\n              _context.next = 9;\n              break;\n\n            case 5:\n              _context.prev = 5;\n              _context.t0 = _context[\"catch\"](0);\n              setFailed(true);\n              throw _context.t0;\n\n            case 9:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[0, 5]]);\n    }));\n  });\n  var elementRef = useRef(null); // Prevent duplicated trigger of `check` function\n\n  var _useState3 = useState({}),\n      _useState4 = _slicedToArray(_useState3, 2),\n      flag = _useState4[0],\n      setFlag = _useState4[1];\n\n  var nextFlagRef = useRef(flag);\n\n  var _useState5 = useState(),\n      _useState6 = _slicedToArray(_useState5, 2),\n      scrollParent = _useState6[0],\n      setScrollParent = _useState6[1];\n\n  var _useThrottleFn = useThrottleFn(function () {\n    return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n      var element, parent, rect, elementTop, current, nextFlag;\n      return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (!(nextFlagRef.current !== flag)) {\n                _context2.next = 2;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 2:\n              if (props.hasMore) {\n                _context2.next = 4;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 4:\n              element = elementRef.current;\n\n              if (element) {\n                _context2.next = 7;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 7:\n              if (element.offsetParent) {\n                _context2.next = 9;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 9:\n              parent = getScrollParent(element);\n              setScrollParent(parent);\n\n              if (parent) {\n                _context2.next = 13;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 13:\n              rect = element.getBoundingClientRect();\n              elementTop = rect.top;\n              current = isWindow(parent) ? window.innerHeight : parent.getBoundingClientRect().bottom;\n\n              if (!(current >= elementTop - props.threshold)) {\n                _context2.next = 22;\n                break;\n              }\n\n              nextFlag = {};\n              nextFlagRef.current = nextFlag;\n              _context2.next = 21;\n              return doLoadMore(false);\n\n            case 21:\n              setFlag(nextFlag);\n\n            case 22:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n  }, {\n    wait: 100,\n    leading: true,\n    trailing: true\n  }),\n      check = _useThrottleFn.run; // Make sure to trigger `loadMore` when content changes\n\n\n  useEffect(function () {\n    check();\n  });\n  useEffect(function () {\n    var element = elementRef.current;\n    if (!element) return;\n    if (!scrollParent) return;\n\n    function onScroll() {\n      check();\n    }\n\n    scrollParent.addEventListener('scroll', onScroll);\n    return function () {\n      scrollParent.removeEventListener('scroll', onScroll);\n    };\n  }, [scrollParent]);\n\n  function retry() {\n    return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n      return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              setFailed(false);\n              _context3.next = 3;\n              return doLoadMore(true);\n\n            case 3:\n              setFlag(nextFlagRef.current);\n\n            case 4:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    }));\n  }\n\n  return withNativeProps(props, React.createElement(\"div\", {\n    className: classPrefix,\n    ref: elementRef\n  }, typeof props.children === 'function' ? props.children(props.hasMore, failed, retry) : props.children));\n};\n\nvar InfiniteScrollContent = function InfiniteScrollContent(props) {\n  var _useConfig = useConfig(),\n      locale = _useConfig.locale;\n\n  if (!props.hasMore) {\n    return React.createElement(\"span\", null, locale.InfiniteScroll.noMore);\n  }\n\n  if (props.failed) {\n    return React.createElement(\"span\", null, React.createElement(\"span\", {\n      className: \"\".concat(classPrefix, \"-failed-text\")\n    }, locale.InfiniteScroll.failedToLoad), React.createElement(\"a\", {\n      onClick: function onClick() {\n        props.retry();\n      }\n    }, locale.InfiniteScroll.retry));\n  }\n\n  return React.createElement(React.Fragment, null, React.createElement(\"span\", null, locale.common.loading), React.createElement(DotLoading, null));\n};","map":{"version":3,"names":["__awaiter","mergeProps","React","useEffect","useRef","useState","useLockFn","useThrottleFn","withNativeProps","getScrollParent","useConfig","DotLoading","isWindow","element","window","classPrefix","defaultProps","threshold","children","hasMore","failed","retry","createElement","InfiniteScrollContent","InfiniteScroll","p","props","setFailed","doLoadMore","isRetry","loadMore","elementRef","flag","setFlag","nextFlagRef","scrollParent","setScrollParent","current","offsetParent","parent","rect","getBoundingClientRect","elementTop","top","innerHeight","bottom","nextFlag","wait","leading","trailing","check","run","onScroll","addEventListener","removeEventListener","className","ref","locale","noMore","failedToLoad","onClick","Fragment","common","loading"],"sources":["/Users/stoneye/react_project/circle-app-react-hook/node_modules/antd-mobile/es/components/infinite-scroll/infinite-scroll.js"],"sourcesContent":["import { __awaiter } from \"tslib\";\nimport { mergeProps } from '../../utils/with-default-props';\nimport React, { useEffect, useRef, useState } from 'react';\nimport { useLockFn, useThrottleFn } from 'ahooks';\nimport { withNativeProps } from '../../utils/native-props';\nimport { getScrollParent } from '../../utils/get-scroll-parent';\nimport { useConfig } from '../config-provider';\nimport DotLoading from '../dot-loading';\n\nfunction isWindow(element) {\n  return element === window;\n}\n\nconst classPrefix = `adm-infinite-scroll`;\nconst defaultProps = {\n  threshold: 250,\n  children: (hasMore, failed, retry) => React.createElement(InfiniteScrollContent, {\n    hasMore: hasMore,\n    failed: failed,\n    retry: retry\n  })\n};\nexport const InfiniteScroll = p => {\n  const props = mergeProps(defaultProps, p);\n  const [failed, setFailed] = useState(false);\n  const doLoadMore = useLockFn(isRetry => __awaiter(void 0, void 0, void 0, function* () {\n    try {\n      yield props.loadMore(isRetry);\n    } catch (e) {\n      setFailed(true);\n      throw e;\n    }\n  }));\n  const elementRef = useRef(null); // Prevent duplicated trigger of `check` function\n\n  const [flag, setFlag] = useState({});\n  const nextFlagRef = useRef(flag);\n  const [scrollParent, setScrollParent] = useState();\n  const {\n    run: check\n  } = useThrottleFn(() => __awaiter(void 0, void 0, void 0, function* () {\n    if (nextFlagRef.current !== flag) return;\n    if (!props.hasMore) return;\n    const element = elementRef.current;\n    if (!element) return;\n    if (!element.offsetParent) return;\n    const parent = getScrollParent(element);\n    setScrollParent(parent);\n    if (!parent) return;\n    const rect = element.getBoundingClientRect();\n    const elementTop = rect.top;\n    const current = isWindow(parent) ? window.innerHeight : parent.getBoundingClientRect().bottom;\n\n    if (current >= elementTop - props.threshold) {\n      const nextFlag = {};\n      nextFlagRef.current = nextFlag;\n      yield doLoadMore(false);\n      setFlag(nextFlag);\n    }\n  }), {\n    wait: 100,\n    leading: true,\n    trailing: true\n  }); // Make sure to trigger `loadMore` when content changes\n\n  useEffect(() => {\n    check();\n  });\n  useEffect(() => {\n    const element = elementRef.current;\n    if (!element) return;\n    if (!scrollParent) return;\n\n    function onScroll() {\n      check();\n    }\n\n    scrollParent.addEventListener('scroll', onScroll);\n    return () => {\n      scrollParent.removeEventListener('scroll', onScroll);\n    };\n  }, [scrollParent]);\n\n  function retry() {\n    return __awaiter(this, void 0, void 0, function* () {\n      setFailed(false);\n      yield doLoadMore(true);\n      setFlag(nextFlagRef.current);\n    });\n  }\n\n  return withNativeProps(props, React.createElement(\"div\", {\n    className: classPrefix,\n    ref: elementRef\n  }, typeof props.children === 'function' ? props.children(props.hasMore, failed, retry) : props.children));\n};\n\nconst InfiniteScrollContent = props => {\n  const {\n    locale\n  } = useConfig();\n\n  if (!props.hasMore) {\n    return React.createElement(\"span\", null, locale.InfiniteScroll.noMore);\n  }\n\n  if (props.failed) {\n    return React.createElement(\"span\", null, React.createElement(\"span\", {\n      className: `${classPrefix}-failed-text`\n    }, locale.InfiniteScroll.failedToLoad), React.createElement(\"a\", {\n      onClick: () => {\n        props.retry();\n      }\n    }, locale.InfiniteScroll.retry));\n  }\n\n  return React.createElement(React.Fragment, null, React.createElement(\"span\", null, locale.common.loading), React.createElement(DotLoading, null));\n};"],"mappings":"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"},"metadata":{},"sourceType":"module"}